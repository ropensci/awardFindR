#' Search the USAspending database
#' @param keywords Vector of strings to search
#' @inheritParams get_nih
#' @return a data.frame
#' @export
#' @examples
#' \dontrun{
#' results <- usaspend_get(c("qualitative", "interview"),
#'  "2019-01-01", "2020-01-01")
#' }
get_usaspend <- function(keywords, from_date, to_date, verbose) {
  url <- "https://api.usaspending.gov/api/v2/search/spending_by_award/"

  payload <- list(
    fields=c("Award ID", "Recipient Name", "Description",
             "Start Date", "End Date", "Award Amount",
             "Awarding Agency", "Awarding Sub Agency",
             "Funding Agency", "Funding Sub Agency"),
    filters=list(
      agencies=list(
        # These should be agencies that are not covered by:
        # Federal Reporter, NIH RePORTER or NSF
        # because the data is limited from USAspending compared to other sources
        list(name="Department of Agriculture", tier="toptier", type="awarding"),
        list(name="Department of Defense", tier="toptier", type="awarding"),
        list(name="National Aeronautics and Space Administration", tier="toptier",
             type="awarding"),
        list(name="Environmental Protection Agency", tier="toptier",
             type="awarding"),
        list(name="Department of Education", tier="toptier", type="awarding"),
        list(name="Institute of Museum and Library Services", tier="toptier",
             type="awarding"),
        list(name="Smithsonian Institution", tier="toptier", type="awarding"),
        list(name="Department of Commerce", tier="toptier", type="awarding"),
        list(name="Department of Education", tier="toptier", type="awarding"),
        list(name="Department of the Interior", tier="toptier",
             type="awarding")),
      award_type_codes=c("02", "03", "04", "05"), # Only grants
      keywords=as.list(keywords),
      recipient_type_names=list("higher_education"),
      # An array syntax quirk in the API demands this double list(list())
      time_period=list(list(start_date=from_date, end_date=to_date))),
    limit=50, page=1, order="desc", subawards="false"
  )

  # query API
  response <- request(url, "post", verbose, payload)

  awards <- response$results
  if (length(awards)==0) {
    return(NULL)
  }

  # Replace NULL with NA
  awards <- lapply(awards, lapply, function(x)ifelse(is.null(x), NA, x))
  awards <- do.call(rbind.data.frame, awards)

  # Need to loop queries?
  while (response$page_metadata$hasNext == TRUE) {
    payload$page <- response$page_metadata$page + 1
    response <- request(url, "post", verbose, payload)

    temp <- response$results
    temp <- lapply(temp, lapply, function(x)ifelse(is.null(x), NA, x))
    temp <- do.call(rbind.data.frame, temp)

    awards <- rbind.data.frame(awards, temp)
  }

  # Merge any awards that were granted by multiple subagencies under the same ID
  award_sums <- stats::aggregate(Award.Amount ~ Award.ID, data=awards, FUN=sum) # Calculate total award amount
  awards <- stats::aggregate(awards, by=list(awards$Award.ID),
                             FUN=function(x) {paste(unique(x), collapse="; ")}) # Concatenate all fields
  # Drop the concatenated award amount and merge to the summed up one
  awards <- merge(awards[,-which(names(awards) %in% c("Group.1","Award.Amount"))],
                  award_sums, by="Award.ID")


  #awards[] <- lapply(awards,
  #                   function(x) ifelse(is.factor(x),
  #                                      as.character(x), x)) # No factors

  awards
}

.standardize_usaspend <- function(keywords, from_date, to_date, verbose) {
  raw <- get_usaspend(keywords, from_date, to_date, verbose)
  if (is.null(raw)) {
    message("No results from USAspending")
    return(NULL)
  }

  with(raw, data.frame(
    institution=Recipient.Name, pi=NA, year=substr(Start.Date, 1, 4),
    start=Start.Date, end=End.Date, program=Awarding.Agency,
    amount=as.integer(Award.Amount), id=Award.ID, title=Description,
    abstract=NA, keyword=NA, source="USASpending", stringsAsFactors = FALSE
  ))
}
